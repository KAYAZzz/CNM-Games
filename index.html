<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CNM Games</title>

  <!-- Icons -->
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logo.png">
  <link rel="icon" href="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logo.png" type="image/png">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    :root { --bg: #1a1a2e; --muted: #9CA3AF; --accent: #6d28d9; --accent2: #f87171; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: #e6edf3; -webkit-font-smoothing:antialiased; }

    /* Plasma background */
    .plasma-background {
      background:
        radial-gradient(circle at 10% 20%, rgba(200,20,255,0.06) 0%, rgba(0,0,0,0) 60%),
        radial-gradient(circle at 90% 80%, rgba(100,0,255,0.05) 0%, rgba(0,0,0,0) 60%),
        var(--bg);
      background-size: 200% 200%;
      animation: movePlasma 40s ease-in-out infinite alternate;
    }
    @keyframes movePlasma { 0%{background-position:0% 0%}100%{background-position:100% 100%} }

    /* Chromatic / shiny text used across titles */
    .shiny-text {
      background-image: linear-gradient(90deg, #6d28d9 0%, #f87171 25%, #a78bfa 50%, #f87171 75%, #6d28d9 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      display:inline-block;
      /* subtle shimmering */
      animation: shine 4s linear infinite;
    }
    @keyframes shine { to { background-position: 200% center; } }

    /* No breathing on splash/logo: we'll not apply scale animation there. */

    /* Intro card / side panels */
    .intro, .side-panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.03);
      box-shadow: 0 8px 30px rgba(20,12,40,0.6);
    }

    /* Splash */
    #splash { background: rgba(10,8,20,0.95); position: fixed; inset:0; z-index:6000; display:flex; align-items:center; justify-content:center; }
    #splash .splash-inner { text-align:center; }
    #splash img { width:128px; height:128px; object-fit:contain; filter: drop-shadow(0 12px 30px rgba(100,30,150,0.25)); }

    /* popup styles */
    #install-popup .install-card { max-height: 85vh; overflow:auto; }
    #install-popup img.tutorial { width:100%; border-radius:12px; display:block; }

    /* Make icons more clickable and glow */
    .select-icon {
      width:64px; height:64px; object-fit:cover; border-radius:12px; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease;
      box-shadow: 0 6px 20px rgba(8,6,20,0.6);
      border: 2px solid transparent;
    }
    .select-icon:active { transform: scale(.98); }
    .select-icon.selected {
      box-shadow: 0 12px 30px rgba(110,40,220,0.35), 0 0 18px rgba(110,40,220,0.12) inset;
      border-color: rgba(110,40,220,0.5);
    }

    /* glow behind icons */
    .icon-glow {
      display:inline-flex; align-items:center; justify-content:center; padding:8px; border-radius:14px;
      background: linear-gradient(180deg, rgba(110,40,220,0.06), rgba(110,40,220,0.02));
    }

    /* responsive layout for tutorial images - landscape vs portrait */
    .tutorial-row { display:flex; gap:12px; }
    .tutorial-row img { flex:1; max-height:220px; object-fit:cover; border-radius:10px; }

    /* small-screen safe: stack vertically */
    @media (max-width: 860px) {
      .tutorial-row { flex-direction:column; }
      .tutorial-row img { max-height:unset; }
    }
    /* For landscape iPad: make the popup horizontal */
    @media (min-width: 900px) and (orientation: landscape) {
      #install-popup .install-card { display:flex; gap:20px; align-items:flex-start; padding:24px; }
      #install-popup .left { flex: 1 1 55%; }
      #install-popup .right { flex: 1 1 45%; display:flex; flex-direction:column; gap:12px; }
      .tutorial-row img { max-height:280px; }
    }

    /* clear-search button */
    #clear-search { display:flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:999px; background:transparent; }

    /* make sure game modal iframe occupies full */
    #game-modal iframe { width:100%; height:100%; border:0; }

  </style>
</head>
<body class="plasma-background min-h-screen text-gray-100 antialiased">

  <!-- SPLASH (non-breathing) -->
  <div id="splash" aria-hidden="true">
    <div class="splash-inner">
      <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logo.png" alt="CNM Games logo">
      <h2 class="mt-4 text-2xl font-bold shiny-text">CNM Games</h2>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-gray-900/80 backdrop-blur-sm shadow-2xl z-50 w-full">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5 flex flex-col md:flex-row justify-between items-start md:items-center">
      <div class="mb-4 md:mb-0 flex items-center">
        <svg class="w-10 h-10 mr-3 text-pink-400 transform -rotate-15" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight"><span class="shiny-text">CNM Games</span></h1>
      </div>

      <p class="text-xs text-gray-400 mt-2 md:mt-0">User ID: <span id="user-id-display" class="font-mono text-purple-400">Authenticating...</span></p>

      <!-- Search area -->
      <div class="w-full md:w-80 lg:w-96 mt-4 md:mt-0">
        <div class="relative">
          <input id="search-input" type="text" placeholder="Search title or category..."
                 class="w-full py-3 pl-12 pr-12 border border-indigo-500/50 rounded-full focus:ring-4 focus:ring-indigo-500 focus:border-indigo-500 bg-gray-800 text-gray-50 placeholder-gray-400 shadow-xl" />
          <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 h-6 w-6 text-indigo-400 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>

          <!-- Clear button -->
          <button id="clear-search" title="Clear search" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>

        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">
    <!-- Intro + side panel (suggestions) -->
    <section class="intro rounded-2xl p-6 max-w-7xl mx-auto flex flex-col lg:flex-row items-start gap-6">
      <div class="flex items-center gap-4">
        <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logo.png" alt="logo" class="w-16 h-16 rounded-lg icon-glow">
        <div>
          <h2 class="text-2xl font-extrabold"><span class="shiny-text">Welcome to CNM Games</span></h2>
          <p class="text-gray-300 mt-1 max-w-xl">Our hub for free web games â€” browse, launch, and save progress. Suggestions are shown on the right so you don't have to click through popups.</p>
        </div>
      </div>

      <!-- Suggestions panel (matches updates style) -->
      <div class="side-panel p-4 rounded-xl w-full md:w-1/3">
        <h3 class="text-lg font-semibold text-purple-300 mb-2">ðŸŽ® Game Suggestions</h3>

        <!-- Text (no bullets) -->
        <div class="text-gray-300 text-sm space-y-3">
          <p>Want a game added? Click the button below.</p>
          <div class="flex items-center gap-3">
            <div class="icon-glow p-2 rounded-md">
              <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logo.png" class="w-12 h-12 rounded-md select-icon" alt="icon1">
            </div>
            <div class="icon-glow p-2 rounded-md">
              <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Kahoot%20fake.png" class="w-12 h-12 rounded-md select-icon" alt="icon2">
            </div>
            <div class="icon-glow p-2 rounded-md">
              <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/IconAlt.png" class="w-12 h-12 rounded-md select-icon" alt="icon3">
            </div>
          </div>

          <a id="suggest-btn" class="inline-block w-full text-center bg-indigo-600 text-white py-2 rounded-lg font-semibold text-sm hover:bg-indigo-700 transition transform hover:scale-[1.02] shadow-md mt-2" href="#" role="button">Suggest a Game</a>
        </div>
      </div>
    </section>

    <!-- Counter + grid -->
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <h2 class="text-3xl font-bold text-gray-200">Total Games:</h2>
        <span id="game-count" class="text-pink-400 text-4xl font-extrabold tracking-tight">0</span>
      </div>
    </div>

    <div id="game-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
      <!-- cards inserted by JS -->
    </div>
  </main>

  <!-- Panic button -->
  <button id="panic-button" class="fixed bottom-4 right-4 z-[2000] p-4 text-white bg-red-600 rounded-full shadow-2xl hover:bg-red-700 transition transform hover:scale-[1.05] font-bold text-lg" title="Quick Escape (Esc)">
    <svg class="w-6 h-6 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
    </svg>
  </button>

  <!-- Game modal -->
  <div id="game-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 items-center justify-center hidden z-[1000]">
    <div class="w-full h-full relative">
      <button id="close-modal-btn" class="absolute top-2 right-2 z-50 bg-red-600 text-white p-3 m-2 rounded-full">âœ•</button>
      <div id="loading-overlay" class="absolute inset-0 flex flex-col items-center justify-center p-8 z-40">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-500 mb-4"></div>
        <p id="loading-text" class="text-xl text-gray-400">Loading external game...</p>
        <div id="link-fallback" class="hidden text-center mt-6 p-6 max-w-lg w-full rounded-xl bg-gray-800/50 shadow-2xl border-t-4 border-indigo-500">
          <p class="text-sm text-gray-300 mb-4">The game didn't load inside the hub. Try opening in a new tab.</p>
          <a id="open-in-new-tab" href="#" target="_blank" class="inline-block bg-indigo-600 text-white py-3 px-6 rounded-full">Open Game in New Tab</a>
        </div>
      </div>
      <iframe id="game-iframe" src="" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    </div>
  </div>

  <!-- Add-to-Home popup (single card) -->
  <div id="install-popup" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[4000] hidden">
    <div class="install-card bg-gray-900 text-gray-100 rounded-2xl p-6 max-w-4xl w-[94%] shadow-2xl">
      <div class="left">
        <h2 class="text-2xl font-bold text-purple-300 mb-2">ðŸ“± Add CNM Games to Your Home Screen</h2>
        <p class="text-gray-300 mb-4">For the best experience, follow these quick visual steps â€” then click Next.</p>

        <div class="tutorial-row mb-4 gap-3">
          <img class="tutorial rounded-lg" src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Tut1.jpg" alt="Step 1">
          <img class="tutorial rounded-lg" src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Tut2.jpeg" alt="Step 2">
          <img class="tutorial rounded-lg" src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Tut3.jpeg" alt="Step 3">
        </div>

        <div class="text-gray-300 text-sm mb-2">
          <strong>Tip:</strong> Once added, you can edit the home screen to hide labels or make icons larger for a cleaner look.
        </div>

        <div class="flex justify-between items-center mt-4">
          <button id="skip-popup" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md text-sm font-medium">No, thanks</button>
          <button id="next-step" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-md text-sm font-semibold">Next</button>
        </div>
      </div>

      <div class="right hidden md:block">
        <h3 class="text-lg font-semibold text-purple-300 mb-2">Choose Icon</h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="icon-glow p-2 flex items-center justify-center">
            <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Logo.png" class="select-icon" alt="icon A">
          </div>
          <div class="icon-glow p-2 flex items-center justify-center">
            <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/Kahoot%20fake.png" class="select-icon" alt="icon B">
          </div>
          <div class="icon-glow p-2 flex items-center justify-center">
            <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/IconAlt.png" class="select-icon" alt="icon C">
          </div>
          <div class="icon-glow p-2 flex items-center justify-center">
            <img src="https://raw.githubusercontent.com/KAYAZzz/CNM-Games/main/teamsfake.png" class="select-icon" alt="icon D">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main module script (games, firebase-safe, search + clear button) -->
  <script type="module">
    // minimal safe firebase imports usage (will only run if config present)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // DOM
    const gameGrid = document.getElementById('game-grid');
    const searchInput = document.getElementById('search-input');
    const clearBtn = document.getElementById('clear-search');
    const gameCountDisplay = document.getElementById('game-count');
    const userIdDisplay = document.getElementById('user-id-display');
    const gameModal = document.getElementById('game-modal');
    const gameIframe = document.getElementById('game-iframe');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const panicButton = document.getElementById('panic-button');
    const loadingOverlay = document.getElementById('loading-overlay');
    const linkFallback = document.getElementById('link-fallback');
    const openInNewTabLink = document.getElementById('open-in-new-tab');

    // install popup elements
    const installPopup = document.getElementById('install-popup');
    const nextStepBtn = document.getElementById('next-step');
    const skipBtn = document.getElementById('skip-popup');
    const selectIcons = Array.from(document.querySelectorAll('.select-icon'));
    let selectedIcon = null;

    // state
    let searchTerm = '';
    let loadTimeout;
    let db, auth;
    let userId = 'loading';
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? (typeof __firebase_config === 'string' ? JSON.parse(__firebase_config||'{}') : __firebase_config) : {};

    // games array trimmed for brevity - **replace or append** with your full set as needed
    const initialGames = [
      { id: 5, title: "2048", description: "Slide and merge numbered tiles on a grid to create the 2048 tile.", category: "Puzzle", gameUrl: "https://cnm-game-library.vercel.app/2048/index.html", imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/2048.png" },
      { id: 7, title: "BTD4", description: "Bloons TD 4", category: "Tower Defense", gameUrl: "https://cnm-game-library.vercel.app/btd4/index.html", imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/BTD4.jpg" },
            { id: 6, title: "Bitlife", description: "Live a virtual life simulation, making choices that determine your career, relationships, and death.", category: "Simulation", gameUrl: GITHUB_BASE_URL + "bitlife/index.html", imgUrl: THUMBNAILS_DIR + "Bitlife.webp" },
            { id: 8, title: "Chess", description: "The classic board game of strategy and tactics. Outwit your opponent to deliver checkmate.", category: "Strategy", gameUrl: GITHUB_BASE_URL + "chess/index.html", imgUrl: THUMBNAILS_DIR + "chess.jpg" }, 
            { id: 9, title: "Cookie Clicker", description: "A highly addictive incremental game where you click a cookie to generate more cookies.", category: "Idle Clicker", gameUrl: GITHUB_BASE_URL + "cookieclicker/index.html", imgUrl: THUMBNAILS_DIR + "Cookie-Clicker.jpg" }, 
            { id: 10, title: "Drive Mad", description: "Drive huge monster trucks and try not to flip over in this physics-based driving game.", category: "Racing", gameUrl: GITHUB_BASE_URL + "drivemad/index.html", imgUrl: THUMBNAILS_DIR + "Drive-Mad.jpg" }, 
            { id: 2, title: "Flappy Bird", description: "Test your skill and patience by tapping to guide the bird through the challenging pipes.", category: "Arcade", gameUrl: GITHUB_BASE_URL + "flappybird/index.html", imgUrl: THUMBNAILS_DIR + "Flappy-Bird.jpg" }, 
            { id: 3, title: "Geo Dash", description: "Jump and fly your way through geometric worlds, synced to an electrifying beat.", category: "Rhythm", gameUrl: GITHUB_BASE_URL + "geometrydash/index.html", imgUrl: THUMBNAILS_DIR + "Geometry-Dash.webp" }, 
            { id: 15, title: "Google Snake", description: "The classic arcade Snake game with a clean, modern twist. Eat apples and grow long!", category: "Arcade", gameUrl: "https://raw.githack.com/KAYAZzz/CNM-Game-Library/main/Snake/index.html", imgUrl: THUMBNAILS_DIR + "Google-Snake.jpg" }, 
            { id: 11, title: "Monkey Mart", description: "Run your own supermarket with the help of busy monkeys! Harvest and stock shelves.", category: "Simulation", gameUrl: GITHUB_BASE_URL + "monkeymart/index.html", imgUrl: THUMBNAILS_DIR + "Monkey-Mart.jpg" }, 
            { id: 12, title: "PacMan", description: "The arcade classic! Eat all the dots, avoid the ghosts, and grab the power pellets.", category: "Arcade", gameUrl: GITHUB_BASE_URL + "pacman/index.html", imgUrl: THUMBNAILS_DIR + "Pacman.jpg" }, 
            { id: 1, title: "Retro Ball", description: "Manage your American football team and call the shots on the field in glorious 8-bit style.", category: "Sports", gameUrl: GITHUB_BASE_URL + "retrobowl/index.html", imgUrl: THUMBNAILS_DIR + "Retro-Ball.webp" }, 
            { id: 14, title: "Slope", description: "Navigate a steep, endless slope, avoiding obstacles and trying to stay on the track.", category: "Endless Runner", gameUrl: "https://raw.githack.com/KAYAZzz/CNM-Game-Library/main/Slope/index.html", imgUrl: THUMBNAILS_DIR + "slope.png" }, 
            { id: 16, title: "Snow Battle", description: "Throw snowballs at your enemies and duck behind cover in this fun, tactical winter battle game.", category: "Arcade", gameUrl: GITHUB_BASE_URL + "snowbattle/index.html", imgUrl: THUMBNAILS_DIR + "Snow-Battle.png" }, 
            { id: 17, title: "Stack", description: "A fast-paced reflex game where you try to stack blocks perfectly to build the tallest tower.", category: "Puzzle", gameUrl: GITHUB_BASE_URL + "stack/index.html", imgUrl: THUMBNAILS_DIR + "Stack.webp" },
            { id: 4, title: "Drift Boss", description: "Drift!", category: "Racing", gameUrl: "https://cnm-game-library.vercel.app/DriftBoss/index.html", imgUrl: THUMBNAILS_DIR + "Drift1.jpg" },
            { 
                id: 18, 
                title: "Subway Surfers", 
                description: "Hosted externally. May require opening in a new tab.", 
                category: "Endless Runner", 
                gameUrl: "https://raw.githack.com/testingherokuapp/subwaysurfer/main/index.html", 
                imgUrl: THUMBNAILS_DIR + "Subway-Surfers.jpg" 
            },
            // --- NEW GAMES ADDED BELOW ---
            { id: 19, title: "Baldi's Basics", description: "Collect notebooks while avoiding the terrifying teacher, Baldi, in this survival horror parody.", category: "Horror/Educational", gameUrl: GITHUB_BASE_URL + "baldisbasics/index.html", imgUrl: THUMBNAILS_DIR + "BaldisBasics.webp" },
            { 
                id: 20, 
                title: "Dino Runner", 
                description: "The classic offline runner. Jump over cacti and duck under pterodactyls to survive.", 
                category: "Endless Runner", 
                gameUrl: "https://cnm-game-library.vercel.app/chromedino/index.html", // UPDATED URL
                imgUrl: THUMBNAILS_DIR + "Dino.jpg" 
            },
            { 
                id: 21, 
                title: "Stickman Hook", 
                description: "Swing like Spider-Man using your hook to navigate levels without falling.", 
                category: "Arcade/Physics", 
                gameUrl: "https://cnm-game-library.vercel.app/StickmanHook/index.html", 
                imgUrl: THUMBNAILS_DIR + "stickman-hook.png" 
            },
            { 
                id: 23, 
                title: "Block Blast", 
                description: "Drag and drop colorful blocks to complete lines and squares in this challenging puzzle game.", 
                category: "Puzzle", 
                gameUrl: "https://cnm-game-library.vercel.app/blockblast/index.html", 
                imgUrl: THUMBNAILS_DIR + "block-blast.jpeg" 
            },
            { 
                id: 24, 
                title: "Merge Rot", 
                description: "Merge rotating blocks and achieve the highest score in this spatial puzzle challenge.", 
                category: "Puzzle", 
                gameUrl: "https://cnm-game-library.vercel.app/MergeRot/index.html", 
                imgUrl: THUMBNAILS_DIR + "merge-rot.png" // Updated to use the provided thumbnail
            },
            { 
                id: 25, 
                title: "Hole.io", 
                description: "Gobble Up The City and Players Around you to be Victorious!", 
                category: "Arcade", 
                gameUrl: "https://cnm-game-library.vercel.app/HoleIO/index.html", 
                imgUrl: THUMBNAILS_DIR + "Hole.png" // Updated to use the provided thumbnail
            },
            {
                id: 26, 
                title: "Sausage Flip", 
                description: "Flip the Sausage of the pan to get to the Finish Line!", 
                category: "Arcade/Physics", 
                gameUrl: "https://cnm-game-library.vercel.app/sausage-flip/index.html", 
                imgUrl: THUMBNAILS_DIR + "sausage-flip.png" // Updated to use the provided thumbnail
            },
            {
                id: 27, 
                title: "YoHoHo.io", 
                description: "A battle Royale Amongst Pirates on Your Island", 
                category: "Battle Royale", 
                gameUrl: "https://raw.githack.com/Sephirin/haleyschool.github.io/main/game/yohoho-io.html", 
                imgUrl: THUMBNAILS_DIR + "Yohoho.jpg" // Updated to use the provided thumbnail
            },
            {
                id: 28, 
                title: "Mr.Bullet", 
                description: "Assassinate Criminals around You using your Pistol", 
                category: "Puzzle", 
                gameUrl: "https://cnm-game-library.vercel.app/MrBullet/index.html", 
                imgUrl: THUMBNAILS_DIR + "Bullet.jpg" // Updated to use the provided thumbnail
            },
            {
                id: 29, 
                title: "The Impossible Quiz", 
                description: "Solve Questions In this Quiz to see how Smart You really are!", 
                category: "Puzzle", 
                gameUrl: "https://raw.githack.com/selenite-cc/selenite-old/main/theimpossiblequiz/index.html", 
                imgUrl: THUMBNAILS_DIR + "Impossible.png" // Updated to use the provided thumbnail
            },
            {
                id: 30,
                title: "Paper.io",
                description: "Claim territory and surround opponents in this addictive multiplayer strategy game.",
                category: "Strategy/IO",
                gameUrl: GITHUB_BASE_URL + "paperio/index.html",
                imgUrl: THUMBNAILS_DIR + "paper-io.png"
            },
            {
                id: 31,
                title: "Hill Climb Racing",
                description: "Drive across hilly terrain, collect coins, and avoid flipping your vehicle.",
                category: "Racing",
                gameUrl: "https://raw.githack.com/KAYAZzz/CNM-Game-Library/main/HillClimbRacing/index.html",
                imgUrl: THUMBNAILS_DIR + "HillClimb.png"
            },
            {
                id: 34,
                title: "Bottle Flip",
                description: "Flip the bottle perfectly onto platforms and test your timing and skill.",
                category: "Skill/Arcade",
                gameUrl: "https://cnm-game-library.vercel.app/BottleFlip2/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/bottleflip.png"
            },
            {
                id: 35,
                title: "Penalty Kicks",
                description: "Score goals and defend shots in this fast-paced soccer penalty shootout game.",
                category: "Sports",
                gameUrl: "https://cnm-game-library.vercel.app/PenaltyKicks/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/penalty.jpg"
            },
            {
                id: 36,
                title: "Gun Spin",
                description: "Score goals and defend shots in this fast-paced soccer penalty shootout game.",
                category: "Arcade",
                gameUrl: "https://cnm-game-library.vercel.app/Gunspin/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/gunspin.png"
            },
            {
                id: 37,
                title: "SandBoxel",
                description: "Create, destroy, and experiment with different materials in a physics-based sandbox world.",
                category: "Simulation",
                gameUrl: "https://raw.githack.com/R74nCom/sandboxels/main/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/Sandboxel.png"
            },
            {
                id: 38,
                title: "Ballistic",
                description: "Aim and shoot volleys of balls to smash numbered bricks â€” donâ€™t let the stack reach the bottom.",
                category: "Puzzle",
                gameUrl: "https://ballisticcnm.vercel.app/",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/ballistic.png"
            },
            {
                id: 39,
                title: "Stacktris",
                description: "Stack spinning blocks to build the tallest tower without letting it fall.",
                category: "Arcade/Puzzle",
                gameUrl: "https://cnm-game-library.vercel.app/stacktris/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/stacktris.jpeg"
            },
            {
                id: 40,
                title: "Tomb Of The Mask",
                description: "Climb walls and race through fast vertical mazes, collecting coins and avoiding traps.",
                category: "Arcade/Puzzle",
                gameUrl: "https://raw.githack.com/HTML5GameArchive/gfiles/master/games/tombofthemask/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/TofM.jpg"
            },
            {
                id: 41,
                title: "Paper Plane",
                description: "Fly your paper plane as far as possible, dodging obstacles and performing stunts.",
                category: "Arcade",
                gameUrl: "https://cnm-game-library.vercel.app/PaperFlight1/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/Planef.jpg"
            },
            {
                id: 42,
                title: "Curve Rush",
                description: "Guide your ball along twisting tracks at high speed without falling off.",
                category: "Arcade",
                gameUrl: "https://curverush.com/curve-rush.embed",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/curve-rush.webp"
            },
            {
                id: 43,
                title: "Burrito Bison",
                description: "Launch yourself through the air, smash gummies, and upgrade to fly even farther.",
                category: "Action / Arcade",
                gameUrl: "https://burrito-bison-cnm.vercel.app/",
                imgUrl: "https://raw.githack.com/KAYAZzz/cnm-games.github.io/main/Thumbnails/Bb.png"
            },
            {
                id: 43,
                title: "Golf Orbit",
                description: "Launch golf balls into orbit and see how far across the planet you can hit them.",
                category: "Sports / Arcade",
                gameUrl: "https://golf-orbit-k8ue.vercel.app/",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/golf-orbit.png"
            },
            {
                id: 44,
                title: "Ragdoll Archers",
                description: "Aim and shoot arrows in ragdoll physics battles against opponents.",
                category: "Action / Physics",
                gameUrl: "https://cnm-game-library.vercel.app/Ragdoll-Archers/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/ragdoll-archers.jpg"
            },
            {
                id: 45,
                title: "Helix Jump",
                description: "Bounce a ball down a twisting helix tower while avoiding the colored traps",
                category: "Arcade",
                gameUrl: "https://cnm-game-library.vercel.app/helixjump/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/HelixJ.webp"
            },
            {
                id: 46,
                title: "PolyTrack",
                description: "Race through vibrant low-poly tracks and compete for the fastest time.",
                category: "Racing",
                gameUrl: "https://raw.githack.com/AnonymousBirb5100/polytrack/main/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/Polyt.webp"
            },
            {
                id: 47,
                title: "Gobble",
                description: "Eat smaller objects to grow bigger while avoiding anything larger than you",
                category: "Arcade / IO",
                gameUrl: "https://cnm-game-library.vercel.app/Gobble/gobble/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/Gobble.png"
            },
            {
                id: 48,
                title: "Swingo",
                description: "Swing and bounce through colorful levels using a stretchy grappling hook.",
                category: "Arcade / Platformer",
                gameUrl: "https://cnm-game-library.vercel.app/Swingo/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/CNM-Games/main/Thumbnails/swingo.jpg"
            },
            {
                id: 49,
                title: "Spiral Roll",
                description: "Carve wood to create spirals that clear obstacles and earn points.",
                category: "Arcade / Skill",
                gameUrl: "https://spiralroll.vercel.app/",
                imgUrl: "https://raw.githack.com/KAYAZzz/cnm-games.github.io/main/Thumbnails/Spiralr.png"
            },
            {
                id: 50,
                title: "Wordle",
                description: "Word puzzle game where players have six tries to guess a hidden five-letter word using color-coded clues",
                category: "Puzzle",
                gameUrl: "https://wordle-actual.vercel.app",
                imgUrl: "https://raw.githack.com/KAYAZzz/cnm-games.github.io/main/Thumbnails/IMG_0829.jpeg"
            },
            {
                id: 51,
                title: "Unicycle Heroes",
                description: "Unicycle Hero is a physics-based sports game where you balance on a unicycle and compete in throwing events.",
                category: "Physics",
                gameUrl: "https://unicycleh.vercel.app",
                imgUrl: "https://raw.githack.com/KAYAZzz/cnm-games.github.io/main/Thumbnails/IMG_0832.jpeg"
            },
            {
                id: 52,
                title: "Sheep Sheep",
                description: "Match and collect adorable sheep in this relaxing puzzle game.",
                category: "Puzzle",
                gameUrl: "https://ubgfun.github.io/puzzle/hell-tile/",
                imgUrl: "https://raw.githack.com/KAYAZzz/cnm-games.github.io/main/Thumbnails/Sheep.jpeg"
            },
            {
                id: 53,
                title: "Game Inside Game",
                description: "Play a series of mini-games that appear within each other in a fun, layered challenge.",
                category: "Arcade / Puzzle",
                gameUrl: "https://cnm-game-library.vercel.app/game-inside/index.html",
                imgUrl: "https://raw.githack.com/KAYAZzz/cnm-games/main/Thumbnails/GameInsideGame.png"
            },
    ];

    // safety init firebase if config present
    async function initializeFirebase() {
      if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
        userId = crypto.randomUUID();
        userIdDisplay.textContent = `${userId} (No persistence)`;
        return;
      }
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('debug');
        await new Promise((resolve) => {
          const unsubscribe = onAuthStateChanged(auth, async (user) => {
            if (!user) {
              const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
              if (token) await signInWithCustomToken(auth, token);
              else await signInAnonymously(auth);
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            userIdDisplay.textContent = userId;
            unsubscribe();
            resolve();
          });
        });
      } catch (err) {
        console.warn('Firebase init failed', err);
        userId = crypto.randomUUID();
        userIdDisplay.textContent = `${userId} (Auth failed)`;
      }
    }

    // open modal
    window.openGameModal = function(url, gameId) {
      gameIframe.src = '';
      openInNewTabLink.href = url;
      gameModal.classList.remove('hidden');
      gameModal.classList.add('flex');
      loadingOverlay.style.display = 'flex';
      gameIframe.src = url;
      clearTimeout(loadTimeout);
      loadTimeout = setTimeout(() => {
        loadingOverlay.style.display = 'flex';
        linkFallback.classList.remove('hidden');
      }, 5000);
      gameIframe.onload = () => {
        clearTimeout(loadTimeout);
        loadingOverlay.style.display = 'none';
      };
    };

    function closeGameModal() {
      clearTimeout(loadTimeout);
      gameIframe.onload = null;
      gameIframe.src = '';
      gameModal.classList.add('hidden');
      gameModal.classList.remove('flex');
    }

    // create card HTML
    function createGameCardHTML(game) {
      const safeUrl = game.gameUrl.replace(/'/g, "\\'");
      return `
        <div class="bg-gray-800 rounded-xl shadow-xl overflow-hidden cursor-pointer transform transition duration-300 hover:scale-[1.03]" data-url="${game.gameUrl}" onclick="openGameModal('${safeUrl}', ${game.id})">
          <div class="h-40 bg-gray-900 relative overflow-hidden">
            <img src="${game.imgUrl}" alt="${game.title} Thumbnail" class="w-full h-full object-cover transition-transform duration-500 ease-in-out hover:scale-110" onerror="this.onerror=null;this.src='https://placehold.co/400x220/DC2626/ffffff?text=Image+Load+FAIL';">
            <span class="absolute top-3 right-3 text-xs font-semibold px-3 py-1 rounded-full bg-purple-600 text-white shadow-md">${game.category}</span>
          </div>
          <div class="p-4">
            <h2 class="text-xl font-bold text-gray-50 truncate mb-1">${game.title}</h2>
            <p class="text-sm text-gray-400 line-clamp-2">${game.description}</p>
            <button class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold text-sm hover:bg-indigo-700 transition duration-150 pointer-events-none">Launch Game</button>
          </div>
        </div>`;
    }

    function renderGameCards() {
      const term = searchTerm.trim().toLowerCase();
      const filtered = initialGames.filter(g =>
        g.title.toLowerCase().includes(term) ||
        g.category.toLowerCase().includes(term) ||
        g.description.toLowerCase().includes(term)
      );
      gameCountDisplay.textContent = filtered.length;
      gameGrid.innerHTML = filtered.length ? filtered.map(createGameCardHTML).join('') : `<p class="text-xl text-gray-400 col-span-full text-center py-10 border-2 border-dashed border-gray-700 p-6 rounded-xl"><span class="text-2xl block mb-2">ðŸ˜”</span>No games found matching "${searchTerm}".</p>`;
    }

    // search + clear button wiring
    searchInput.addEventListener('input', (e) => {
      searchTerm = e.target.value;
      renderGameCards();
      clearBtn.classList.toggle('hidden', searchInput.value === '');
    });
    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      searchTerm = '';
      renderGameCards();
      clearBtn.classList.add('hidden');
      searchInput.focus();
    });

    // basic event bindings
    closeModalBtn?.addEventListener('click', closeGameModal);
    panicButton.addEventListener('click', () => window.location.href = "https://member.foodvillage.ie/login");
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (!gameModal.classList.contains('hidden')) closeGameModal();
        else window.location.href = "https://member.foodvillage.ie/login";
      }
    });

    // install popup logic (single-card flow)
    function showInstallPopup() {
      if (!localStorage.getItem('installDismissed')) {
        installPopup.classList.remove('hidden');
      }
    }
    nextStepBtn?.addEventListener('click', () => {
      // In this simplified single-card flow, Next just advances UI focus to icon selection on small screens:
      // On MD+ the icon area is already visible; For small screens we scroll to bottom to show icons.
      const icons = installPopup.querySelectorAll('.select-icon');
      if (icons.length) {
        icons[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        // finish if none
        localStorage.setItem('installDismissed', 'true');
        installPopup.classList.add('hidden');
      }
    });
    skipBtn?.addEventListener('click', () => {
      localStorage.setItem('installDismissed', 'true');
      installPopup.classList.add('hidden');
    });

    // icon selection
    selectIcons.forEach(ic => {
      ic.addEventListener('click', () => {
        selectIcons.forEach(el => el.classList.remove('selected'));
        ic.classList.add('selected');
        selectedIcon = ic.src;
        // update apple-touch-icon link dynamically for preview
        const link = document.querySelector("link[rel='apple-touch-icon']");
        if (link) link.href = selectedIcon;
      });
    });

    // startup
    window.addEventListener('load', async () => {
      await initializeFirebase();
      renderGameCards();
      // show install popup (delay so it doesn't flash)
      setTimeout(showInstallPopup, 700);
    });

    // expose small API for debug
    window._cnm = { renderGameCards, initialGames };

  </script>

  <!-- splash fade script & popup close on outside clicks -->
  <script>
    window.addEventListener('load', () => {
      const splash = document.getElementById('splash');
      setTimeout(() => {
        splash.style.transition = 'opacity .6s ease';
        splash.style.opacity = '0';
        setTimeout(() => splash.remove(), 700);
      }, 1600);

      // close install popup when clicking outside (safely)
      const popup = document.getElementById('install-popup');
      if (popup) {
        popup.addEventListener('click', (e) => {
          if (e.target === popup) {
            localStorage.setItem('installDismissed', 'true');
            popup.classList.add('hidden');
          }
        });
      }

      // make select icons easier to tap: increase hit area
      document.querySelectorAll('.select-icon').forEach(img => {
        const wrapper = img.closest('.icon-glow') || img.parentElement;
        if (wrapper) {
          wrapper.addEventListener('click', () => img.click());
          wrapper.style.cursor = 'pointer';
        }
      });
    });
  </script>
</body>
</html>
